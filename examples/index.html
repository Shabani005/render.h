<canvas id="mycanva" width="600" height="400"></canvas>

<script>
function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

function rd_fill_background(api, rd_canvas, col) {
  api.fill_background(rd_canvas.canvas, col);
}

function rd_draw_rect(api, rd_canvas, w, h, x, y, col) {
  api.draw_rect(rd_canvas.canvas, w, h, x, y, col);
}

function rd_init_canvas(api, w, h, canvaId, memory) {
  const c = api.make_canvas(w, h);
  const ptr = api.canvas_pixels(c);
  const p = new Uint32Array(memory.buffer, ptr, w * h);
  window.pixels = p;
  const canva = document.getElementById(canvaId);
  const ctx = canva.getContext("2d");
  return { canvas: c, pixels: p, context: ctx, pointer: ptr };
}

function rd_refresh_img(api, c, ctx, memory, ptr) {
  const w = api.canvas_width(c);
  const h = api.canvas_height(c);
  const img = ctx.createImageData(w, h);
  img.data.set(new Uint8ClampedArray(memory.buffer, ptr, w * h * 4));
  ctx.putImageData(img, 0, 0);
}

async function main() {
  const buf = await fetch("renderer.wasm").then((r) => r.arrayBuffer());
  const { instance } = await WebAssembly.instantiate(buf, {});
  const api = instance.exports;
  const memory = api.memory;

  const rd_canvas = rd_init_canvas(api, 2560, 1440, "mycanva", memory);
  const { canvas, context, pointer } = rd_canvas;

  const fps = 60;
  const dt = 1 / fps;
  let x = 0;
  let y = 0;

  while (true) {
    rd_fill_background(api, rd_canvas, 0x181818ff);
    rd_draw_rect(api, rd_canvas, 50, 40, x, y, 0xff0000ff);
    rd_refresh_img(api, canvas, context, memory, pointer);
    x += 20 * dt;
    y += 20 * dt;
    await sleep(dt * 1000);
  }
}

main();
</script>
